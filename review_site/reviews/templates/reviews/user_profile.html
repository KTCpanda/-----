{% extends 'reviews/base.html' %}

{% block content %}
    <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
        <!-- プロフィールヘッダー -->
        <div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 20px;">
                <!-- プロフィール画像 -->
                <div>
                    {% if profile.get_avatar_url %}
                        <img src="{{ profile.get_avatar_url }}" alt="{{ profile_user.username }}のプロフィール画像" 
                             style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #ddd;">
                    {% else %}
                        <div style="width: 100px; height: 100px; border-radius: 50%; background-color: #f0f0f0; display: flex; align-items: center; justify-content: center; border: 3px solid #ddd; color: #999; font-size: 36px; font-weight: bold;">
                            {{ profile_user.username|first|upper }}
                        </div>
                    {% endif %}
                </div>
                
                <!-- プロフィール情報 -->
                <div style="flex: 1;">
                    <h1 style="margin: 0 0 10px 0; color: #333;">{{ profile_user.username }}</h1>
                    
                    {% if profile.bio %}
                        <p style="color: #666; margin: 10px 0;">{{ profile.bio }}</p>
                    {% endif %}
                    
                    <div class="followers-info" style="display: flex; gap: 20px; margin: 15px 0;">
                        <span><strong>{{ followers_count }}</strong> フォロワー</span>
                        <span><strong>{{ following_count }}</strong> フォロー中</span>
                        {% if is_friend %}
                            <span class="friend-badge" style="background-color: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                👥 友達
                            </span>
                        {% endif %}
                    </div>
                    
                    <!-- フォローボタンとDMボタン -->
                    {% if user.is_authenticated and user != profile_user %}
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button id="follow-btn" class="follow-btn {% if is_friend %}friend{% elif is_following %}unfollow{% endif %}" onclick="toggleFollow({{ profile_user.id }})">
                                {% if is_friend %}👥 友達{% elif is_following %}フォロー解除{% else %}フォロー{% endif %}
                            </button>
                            <a href="{% url 'send_dm' profile_user.id %}" class="btn btn-primary" style="width: 40px; height: 40px; border-radius: 50%; background-color: #007bff; color: white; text-decoration: none; display: flex; align-items: center; justify-content: center; font-size: 20px;">✉</a>
                        </div>
                    {% endif %}
                    
                    {% if profile.birth_date %}
                        <p style="color: #888; margin-top: 10px; font-size: 14px;">
                            生年月日: {{ profile.birth_date|date:"Y年m月d日" }}
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- タブコンテンツ -->
        <div style="display: flex; gap: 20px;">
            <!-- 投稿した店舗 -->
            <div style="flex: 1; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 style="color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px;">投稿した店舗</h3>
                {% for store in user_stores %}
                    <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
                        <h4><a href="{% url 'store_detail' store.id %}" style="color: #007bff; text-decoration: none;">{{ store.name }}</a></h4>
                        <p style="color: #666; font-size: 14px;">{{ store.address }}</p>
                        <small style="color: #888;">{{ store.created_at|date:"Y/m/d" }}</small>
                    </div>
                {% empty %}
                    <p style="color: #666; text-align: center; margin: 20px 0;">まだ店舗を投稿していません。</p>
                {% endfor %}
            </div>

            <!-- 投稿したレビュー -->
            <div style="flex: 1; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 style="color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px;">投稿したレビュー</h3>
                {% for review in user_reviews %}
                    <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
                        <h4><a href="{% url 'store_detail' review.store.id %}" style="color: #007bff; text-decoration: none;">{{ review.store.name }}</a></h4>
                        <p style="margin: 5px 0;"><strong>評価:</strong> {{ review.get_rating_display }}</p>
                        {% if review.comment %}
                            <p style="color: #666; font-size: 14px;">{{ review.comment|truncatewords:20 }}</p>
                        {% endif %}
                        <small style="color: #888;">{{ review.created_at|date:"Y/m/d" }}</small>
                    </div>
                {% empty %}
                    <p style="color: #666; text-align: center; margin: 20px 0;">まだレビューを投稿していません。</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        function toggleFollow(userId) {
            fetch(`/follow/${userId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const followBtn = document.getElementById('follow-btn');
                    const badgeContainer = document.querySelector('.followers-info');
                    let friendBadge = document.querySelector('.friend-badge');

                    // ボタンのクラスをリセット
                    followBtn.classList.remove('friend', 'unfollow');
                    
                    // ボタンとバッジの表示を更新
                    if (data.is_friend) {
                        followBtn.textContent = '👥 友達';
                        followBtn.classList.add('friend');
                        
                        // 友達バッジがなければ追加
                        if (!friendBadge) {
                            friendBadge = document.createElement('span');
                            friendBadge.className = 'friend-badge';
                            friendBadge.style.cssText = 'background-color: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;';
                            friendBadge.innerHTML = '👥 友達';
                            badgeContainer.appendChild(friendBadge);
                        }
                    } else if (data.is_following) {
                        followBtn.textContent = 'フォロー解除';
                        followBtn.classList.add('unfollow');
                        
                        // 友達バッジがあれば削除
                        if (friendBadge) {
                            friendBadge.remove();
                        }
                    } else {
                        followBtn.textContent = 'フォロー';
                        
                        // 友達バッジがあれば削除
                        if (friendBadge) {
                            friendBadge.remove();
                        }
                    }
                    
                    // フォロワー数を更新
                    if (data.followers_count !== undefined) {
                        const followersElement = document.querySelector('.followers-info span:first-child strong');
                        if (followersElement) {
                            followersElement.textContent = data.followers_count;
                        }
                    }
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('エラーが発生しました。');
            });
        }
    </script>
{% endblock %}
