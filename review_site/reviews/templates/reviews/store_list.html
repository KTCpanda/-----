{% extends 'reviews/base.html' %}

{% block content %}
    <h1>お店一覧</h1>

    <div class="search-form">
        <form method="get" action="{% url 'store_list' %}">
            <input type="text" name="q" class="search-input" placeholder="店名や住所で検索..." value="{{ query|default_if_none:'' }}">
            <button type="submit" class="search-button">検索</button>
            {% if query %}
                <a href="{% url 'store_list' %}" style="margin-left: 10px; color: #666; text-decoration: none;">✖ 文字をリセット</a>
            {% endif %}
        </form>
    </div>

    {% if query %}
        <p style="margin: 10px 0; color: #666;">
            「<strong>{{ query }}</strong>」の検索結果: {{ stores.count }}件
        </p>
    {% endif %}
    <hr>

    {# --- あなたのデータベースの検索結果 --- #}
    {% for store in stores %}
        <div class="store-card" data-store-id="{{ store.id }}" style="display: flex; align-items: center; margin-bottom: 15px; padding: 15px; border-bottom: 1px solid #eee; border-radius: 8px; transition: background-color 0.2s, border 0.2s;">
            
            {% if store.image_data %}
                <img src="{{ store.get_image_url }}" alt="{{ store.name }}の画像" style="width: 150px; height: 150px; object-fit: cover; border-radius: 8px; margin-right: 20px;">
            {% else %}
                <div style="width: 150px; height: 150px; background-color: #e8e8e8; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #aaa; margin-right: 20px;">
                    <span>画像なし</span>
                </div>
            {% endif %}
            
            <div>
                <h2><a href="{% url 'store_detail' store.id %}">{{ store.name }}</a></h2>
                <p>住所: {{ store.address }}</p>
                
                {# --- 評価統計を投稿者の上に移動 --- #}
                {% if store.total_reviews > 0 %}
                    <div style="margin: 10px 0;">
                        <p style="font-size: 14px; color: #666; margin-bottom: 5px;">みんなの評価 ({{ store.total_reviews }}件)</p>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            {% for rating_value, stats in store.rating_stats.items %}
                                {% if stats.count > 0 %}
                                    <span style="background-color: #f0f0f0; padding: 2px 8px; border-radius: 12px; font-size: 12px; display: flex; align-items: center;">
                                        {{ stats.label|truncatechars:6 }} {{ stats.count }}人
                                    </span>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                
                <p style="display: flex; align-items: center;">
                    {% if store.created_by.profile and store.created_by.profile.get_avatar_url %}
                        <img src="{{ store.created_by.profile.get_avatar_url }}" alt="{{ store.created_by.username }}のアイコン" 
                             style="width: 20px; height: 20px; border-radius: 50%; margin-right: 6px; object-fit: cover;">
                    {% else %}
                        <div style="width: 20px; height: 20px; border-radius: 50%; background-color: #ddd; margin-right: 6px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #666;">
                            {{ store.created_by.username|first|upper }}
                        </div>
                    {% endif %}
                    登録者: {{ store.created_by.username }}
                    
                    {# --- タグ表示 --- #}
                    <span class="store-tags" style="margin-left: 15px; display: flex; align-items: center; gap: 5px;">
                        {% if store.tags.all %}
                            <span style="color: #666; font-size: 14px;">タグ:</span>
                            {% for tag in store.tags.all %}
                                <span style="background-color: {{ tag.color }}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold;">
                                    {{ tag.name }}
                                </span>
                            {% endfor %}
                        {% endif %}
                    </span>
                </p>
            </div>

        </div>
    {% endfor %}

    {# --- ここからホットペッパーAPIの検索結果を追加 --- #}
    {% if api_stores %}
        <h2 style="margin-top: 40px;">ホットペッパーの検索結果</h2>
        {% for store in api_stores %}
            <div class="store-card" style="display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                
                <img src="{{ store.photo.pc.m }}" alt="{{ store.name }}" style="width: 150px; height: 150px; object-fit: cover; border-radius: 8px; margin-right: 20px;">
                
                <div>
                    <h2>{{ store.name }} ({{ store.station_name }})</h2>
                    <p>住所: {{ store.address }}</p>
                    <p>ジャンル: {{ store.genre.name }}</p>
                </div>
            </div>
        {% endfor %}
    {% endif %}
    {# --- ここまでAPIの検索結果 --- #}


    {# --- 検索結果が0件だった場合の表示 --- #}
    {% if stores.count == 0 %}
        {% if query %}
            <p style="text-align: center; color: #666; margin-top: 40px;">「{{ query }}」に一致するお店は見つかりませんでした。</p>
            <p style="text-align: center;">
                <a href="{% url 'store_list' %}" style="color: #007bff; text-decoration: none;">すべてのお店を表示</a>
            </p>
        {% else %}
            <p style="text-align: center; color: #666; margin-top: 40px;">まだ登録されているお店がありません。</p>
        {% endif %}
    {% endif %}

{% endblock %}
