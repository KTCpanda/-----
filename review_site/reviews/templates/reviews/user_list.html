{% extends 'reviews/base.html' %}

{% block content %}
    <h1 style="margin-bottom: 20px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h1>

    <div class="user-list-container">
        {% for item in users_with_status %}
            {% with user=item.user %}
            <div class="store-card" style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background-color: #fff;">
                
                <!-- ã‚¢ã‚¤ã‚³ãƒ³ -->
                <a href="{% url 'user_profile' user.id %}" style="flex-shrink: 0;">
                    {% if user.profile and user.profile.get_avatar_url %}
                        <img src="{{ user.profile.get_avatar_url }}" alt="{{ user.username }}ã®ã‚¢ã‚¤ã‚³ãƒ³" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%;">
                    {% else %}
                        <div style="width: 100px; height: 100px; background-color: #f0f0f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #aaa;">
                            ç”»åƒãªã—
                        </div>
                    {% endif %}
                </a>
                
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼å -->
                <div style="flex-grow: 1;">
                    <h2 style="margin: 0;">
                        <a href="{% url 'user_profile' user.id %}" style="text-decoration: none; color: #007bff;">{{ user.username }}</a>
                    </h2>
                </div>

                <!-- ãƒ•ã‚©ãƒ­ãƒ¼ãƒœã‚¿ãƒ³ -->
                <div style="margin-left: auto;">
                    {% if item.is_friend %}
                        <a href="{% url 'user_profile' user.id %}" class="btn" style="background-color: #28a745; color: white; text-decoration: none; padding: 5px 10px; border-radius: 20px;">ğŸ‘¥ å‹é”</a>
                    {% elif item.is_following %}
                        <a href="{% url 'user_profile' user.id %}" class="btn" style="background-color: #ccc; color: #333; text-decoration: none; padding: 5px 10px; border-radius: 20px;">ğŸ‘¤â†’ ãƒ•ã‚©ãƒ­ãƒ¼æ¸ˆã¿</a>
                    {% else %}
                        <a href="{% url 'user_profile' user.id %}" class="btn btn-primary" style="background-color: #419dff; color: white; text-decoration: none; padding: 5px 10px; border-radius: 20px;">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¦‹ã‚‹</a>
                    {% endif %}
                </div>
            </div>
            {% endwith %}
        {% empty %}
            <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“ã€‚</p>
        {% endfor %}
    </div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const userListContainer = document.querySelector('.user-list-container');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    userListContainer.addEventListener('click', function(e) {
        // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã®ãŒ .follow-btn ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
        if (!e.target.matches('.follow-btn')) {
            return;
        }

        e.preventDefault();
        const button = e.target;
        const userId = button.dataset.userId;

        fetch(`/follow/${userId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // çŠ¶æ…‹ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
                if (data.is_friend) {
                    button.style.backgroundColor = '#28a745';
                    button.innerHTML = '<i class="fas fa-user-friends" style="margin-right: 8px; color: #663399;"></i>å‹é”';
                    button.classList.remove('btn-primary');
                    button.style.borderRadius = '15px';
                    button.style.padding = '5px 15px';
                    button.style.display = 'inline-flex';
                    button.style.alignItems = 'center';
                    button.href = `/user/${userId}/`;
                } else if (data.is_following) {
                    button.style.backgroundColor = '#ccc';
                    button.innerHTML = 'ãƒ•ã‚©ãƒ­ãƒ¼æ¸ˆã¿';
                    button.classList.remove('btn-primary');
                    button.href = `/user/${userId}/`;
                } else {
                    button.style.backgroundColor = '#007bff';
                    button.innerHTML = 'ãƒ•ã‚©ãƒ­ãƒ¼';
                    button.classList.add('btn-primary');
                    button.href = '#';
                }
            } else {
                alert(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            }
        })
        .catch(error => console.error('Error:', error));
    });
});
</script>
{% endblock %}

{% endblock %}