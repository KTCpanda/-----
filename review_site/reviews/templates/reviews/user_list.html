{% extends 'reviews/base.html' %}

{% block content %}
    <h1 style="margin-bottom: 20px;">ユーザー一覧</h1>

    <div class="user-list-container">
        {% for item in users_with_status %}
            {% with user=item.user %}
            <div class="store-card" style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background-color: #fff;">
                
                <!-- アイコン -->
                <a href="{% url 'user_profile' user.id %}" style="flex-shrink: 0;">
                    {% if user.profile and user.profile.get_avatar_url %}
                        <img src="{{ user.profile.get_avatar_url }}" alt="{{ user.username }}のアイコン" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%;">
                    {% else %}
                        <div style="width: 100px; height: 100px; background-color: #f0f0f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #aaa;">
                            画像なし
                        </div>
                    {% endif %}
                </a>
                
                <!-- ユーザー名 -->
                <div style="flex-grow: 1;">
                    <h2 style="margin: 0;">
                        <a href="{% url 'user_profile' user.id %}" style="text-decoration: none; color: #007bff;">{{ user.username }}</a>
                    </h2>
                </div>

                <!-- フォローボタン -->
                <div style="margin-left: auto;">
                    {% if item.is_friend %}
                        <a href="{% url 'user_profile' user.id %}" class="btn" style="background-color: lightgreen; color: black; text-decoration: none; padding: 8px 15px; border-radius: 5px;">友達</a>
                    {% elif item.is_following %}
                        <a href="{% url 'user_profile' user.id %}" class="btn" style="background-color: #ccc; color: #333; text-decoration: none; padding: 8px 15px; border-radius: 5px;">フォロー済み</a>
                    {% else %}
                        <a href="{% url 'user_profile' user.id %}" class="btn btn-primary" style="background-color: #007bff; color: white; text-decoration: none; padding: 8px 15px; border-radius: 5px;">プロフィールを見る</a>
                    {% endif %}
                </div>
            </div>
            {% endwith %}
        {% empty %}
            <p>ユーザーがいません。</p>
        {% endfor %}
    </div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const userListContainer = document.querySelector('.user-list-container');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    userListContainer.addEventListener('click', function(e) {
        // クリックされたのが .follow-btn かどうかをチェック
        if (!e.target.matches('.follow-btn')) {
            return;
        }

        e.preventDefault();
        const button = e.target;
        const userId = button.dataset.userId;

        fetch(`/follow/${userId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 状態に応じてボタンの表示を更新
                if (data.is_friend) {
                    button.style.backgroundColor = '#28a745';
                    button.innerHTML = '<i class="fas fa-user-friends" style="margin-right: 8px; color: #663399;"></i>友達';
                    button.classList.remove('btn-primary');
                    button.style.borderRadius = '15px';
                    button.style.padding = '5px 15px';
                    button.style.display = 'inline-flex';
                    button.style.alignItems = 'center';
                    button.href = `/user/${userId}/`;
                } else if (data.is_following) {
                    button.style.backgroundColor = '#ccc';
                    button.innerHTML = 'フォロー済み';
                    button.classList.remove('btn-primary');
                    button.href = `/user/${userId}/`;
                } else {
                    button.style.backgroundColor = '#007bff';
                    button.innerHTML = 'フォロー';
                    button.classList.add('btn-primary');
                    button.href = '#';
                }
            } else {
                alert(data.message || 'エラーが発生しました。');
            }
        })
        .catch(error => console.error('Error:', error));
    });
});
</script>
{% endblock %}

{% endblock %}